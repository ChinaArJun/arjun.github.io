(window.webpackJsonp=window.webpackJsonp||[]).push([[188],{624:function(e,t,r){"use strict";r.r(t);var n=r(44),a=Object(n.a)({},(function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[r("h1",{attrs:{id:"_1-10-go-defer-会有性能损耗，尽量不要用？"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_1-10-go-defer-会有性能损耗，尽量不要用？"}},[e._v("#")]),e._v(" 1.10 Go defer 会有性能损耗，尽量不要用？")]),e._v(" "),r("p",[r("img",{attrs:{src:"https://i.imgur.com/YlKjnSH.jpg",alt:"image"}})]),e._v(" "),r("p",[e._v("上个月在 @polaris @轩脉刃 的全栈技术群里看到一个小伙伴问 "),r("strong",[e._v("“说 defer 在栈退出时执行，会有性能损耗，尽量不要用，这个怎么解？”")]),e._v("。")]),e._v(" "),r("p",[e._v("恰好前段时间写了一篇 "),r("a",{attrs:{href:"https://segmentfault.com/a/1190000019303572",target:"_blank",rel:"noopener noreferrer"}},[e._v("《深入理解 Go defer》"),r("OutboundLink")],1),e._v(" 去详细剖析 "),r("code",[e._v("defer")]),e._v(" 关键字。那么这一次简单结合前文对这个问题进行探讨一波，希望对你有所帮助，但在此之前希望你花几分钟，自己思考一下答案，再继续往下看。")]),e._v(" "),r("h2",{attrs:{id:"测试"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#测试"}},[e._v("#")]),e._v(" 测试")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("func DoDefer(key, value string) {\n\tdefer func(key, value string) {\n\t\t_ = key + value\n\t}(key, value)\n}\n\nfunc DoNotDefer(key, value string) {\n\t_ = key + value\n}\n")])])]),r("p",[e._v("基准测试：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v('func BenchmarkDoDefer(b *testing.B) {\n\tfor i := 0; i < b.N; i++ {\n\t\tDoDefer("煎鱼", "https://github.com/EDDYCJY/blog")\n\t}\n}\n\nfunc BenchmarkDoNotDefer(b *testing.B) {\n\tfor i := 0; i < b.N; i++ {\n\t\tDoNotDefer("煎鱼", "https://github.com/EDDYCJY/blog")\n\t}\n}\n')])])]),r("p",[e._v("输出结果：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("$ go test -bench=. -benchmem -run=none\ngoos: darwin\ngoarch: amd64\npkg: github.com/EDDYCJY/awesomeDefer\nBenchmarkDoDefer-4      \t20000000\t        91.4 ns/op\t      48 B/op\t       1 allocs/op\nBenchmarkDoNotDefer-4   \t30000000\t        41.6 ns/op\t      48 B/op\t       1 allocs/op\nPASS\nok  \tgithub.com/EDDYCJY/awesomeDefer\t3.234s\n")])])]),r("p",[e._v("从结果上来，使用 "),r("code",[e._v("defer")]),e._v(" 后的函数开销确实比没使用高了不少，这损耗用到哪里去了呢？")]),e._v(" "),r("h2",{attrs:{id:"想一下"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#想一下"}},[e._v("#")]),e._v(" 想一下")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v('$ go tool compile -S main.go \n"".main STEXT size=163 args=0x0 locals=0x40\n    ...\n    0x0059 00089 (main.go:6)    MOVQ    AX, 16(SP)\n    0x005e 00094 (main.go:6)    MOVQ    $1, 24(SP)\n    0x0067 00103 (main.go:6)    MOVQ    $1, 32(SP)\n    0x0070 00112 (main.go:6)    CALL    runtime.deferproc(SB)\n    0x0075 00117 (main.go:6)    TESTL    AX, AX\n    0x0077 00119 (main.go:6)    JNE    137\n    0x0079 00121 (main.go:7)    XCHGL    AX, AX\n    0x007a 00122 (main.go:7)    CALL    runtime.deferreturn(SB)\n    0x007f 00127 (main.go:7)    MOVQ    56(SP), BP\n    0x0084 00132 (main.go:7)    ADDQ    $64, SP\n    0x0088 00136 (main.go:7)    RET\n    0x0089 00137 (main.go:6)    XCHGL    AX, AX\n    0x008a 00138 (main.go:6)    CALL    runtime.deferreturn(SB)\n    0x008f 00143 (main.go:6)    MOVQ    56(SP), BP\n    0x0094 00148 (main.go:6)    ADDQ    $64, SP\n    0x0098 00152 (main.go:6)    RET\n    ...\n')])])]),r("p",[e._v("我们在前文提到 "),r("code",[e._v("defer")]),e._v(" 关键字其实涉及了一系列的连锁调用，内部 "),r("code",[e._v("runtime")]),e._v(" 函数的调用就至少多了三步，分别是 "),r("code",[e._v("runtime.deferproc")]),e._v(" 一次和 "),r("code",[e._v("runtime.deferreturn")]),e._v(" 两次。")]),e._v(" "),r("p",[e._v("而这还只是在运行时的显式动作，另外编译器做的事也不少，例如：")]),e._v(" "),r("ul",[r("li",[e._v("在 "),r("code",[e._v("deferproc")]),e._v(" 阶段（注册延迟调用），还得获取/传入目标函数地址、函数参数等等。")]),e._v(" "),r("li",[e._v("在 "),r("code",[e._v("deferreturn")]),e._v(" 阶段，需要在函数调用结尾处插入该方法的调用，同时若有被 "),r("code",[e._v("defer")]),e._v(" 的函数，还需要使用 "),r("code",[e._v("runtime·jmpdefer")]),e._v(" 进行跳转以便于后续调用。")])]),e._v(" "),r("p",[e._v("这一些动作途中还要涉及最小单元 "),r("code",[e._v("_defer")]),e._v(" 的获取/生成， "),r("code",[e._v("defer")]),e._v(" 和 "),r("code",[e._v("recover")]),e._v(" 链表的逻辑处理和消耗等动作。")]),e._v(" "),r("h2",{attrs:{id:"q-a"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#q-a"}},[e._v("#")]),e._v(" Q&A")]),e._v(" "),r("p",[e._v("最后讨论的时候有提到 "),r("strong",[e._v("“问题指的是本来就是用来执行 close() 一些操作的，然后说尽量不能用，例子就把 defer db.close() 前面的 defer 删去了”")]),e._v(" 这个疑问。")]),e._v(" "),r("p",[e._v("这是一个比较类似 “教科书” 式的说法，在一些入门教程中会潜移默化的告诉你在资源控制后加个 "),r("code",[e._v("defer")]),e._v(" 延迟关闭一下。例如：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("resp, err := http.Get(...)\nif err != nil {\n    return err\n}\ndefer resp.Body.Close()\n")])])]),r("p",[e._v("但是一定得这么写吗？其实并不，很多人给出的理由都是 “怕你忘记” 这种说辞，这没有毛病。但需要认清场景，假设我的应用场景如下：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("resp, err := http.Get(...)\nif err != nil {\n    return err\n}\ndefer resp.Body.Close()\n// do something\ntime.Sleep(time.Second * 60)\n")])])]),r("p",[e._v("嗯，一个请求当然没问题，流量、并发一下子大了呢，那可能就是个灾难了。你想想为什么？从常见的 "),r("code",[e._v("defer")]),e._v(" + "),r("code",[e._v("close")]),e._v(" 的使用组合来讲，用之前建议先看清楚应用场景，在保证无异常的情况下确保尽早关闭才是首选。如果只是小范围调用很快就返回的话，偷个懒直接一套组合拳出去也未尝不可。")]),e._v(" "),r("h2",{attrs:{id:"结论"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#结论"}},[e._v("#")]),e._v(" 结论")]),e._v(" "),r("p",[e._v("一个 "),r("code",[e._v("defer")]),e._v(" 关键字实际上包含了不少的动作和处理，和你单纯调用一个函数一条指令是没法比的。而与对照物相比，它确确实实是有性能损耗，目前延迟调用的全部开销大约在 50ns，但 "),r("code",[e._v("defer")]),e._v(" 所提供的作用远远大于此，你从全局来看，它的损耗非常小，并且官方还不断地在优化中。")]),e._v(" "),r("p",[e._v("因此，对于 “Go defer 会有性能损耗，尽量不能用？” 这个问题，我认为"),r("strong",[e._v("该用就用，应该及时关闭就不要延迟，在 hot paths 用时一定要想清楚场景")]),e._v("。")]),e._v(" "),r("h2",{attrs:{id:"补充"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#补充"}},[e._v("#")]),e._v(" 补充")]),e._v(" "),r("p",[e._v("最后补充上柴大的回复："),r("strong",[e._v("“不是性能问题，defer 最大的功能是 Panic 后依然有效。如果没有 defer，Panic 后就会导致 unlock 丢失，从而导致死锁了”")]),e._v("，非常经典。")])])}),[],!1,null,null,null);t.default=a.exports}}]);