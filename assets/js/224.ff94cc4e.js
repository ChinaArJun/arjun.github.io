(window.webpackJsonp=window.webpackJsonp||[]).push([[224],{659:function(e,t,n){"use strict";n.r(t);var a=n(44),r=Object(a.a)({},(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[n("h1",{attrs:{id:"_4-9-grpc-deadlines"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-9-grpc-deadlines"}},[e._v("#")]),e._v(" 4.9 gRPC Deadlines")]),e._v(" "),n("h2",{attrs:{id:"前言"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[e._v("#")]),e._v(" 前言")]),e._v(" "),n("p",[e._v("在前面的章节中，已经介绍了 gRPC 的基本用法。那你想想，让它这么裸跑真的没问题吗？")]),e._v(" "),n("p",[e._v("那么，肯定是有问题了。今天将介绍 gRPC Deadlines 的用法，这一个必备技巧。内容也比较简单")]),e._v(" "),n("h2",{attrs:{id:"deadlines"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#deadlines"}},[e._v("#")]),e._v(" Deadlines")]),e._v(" "),n("p",[e._v("Deadlines 意指截止时间，在 gRPC 中强调 TL;DR（Too long, Don't read）并建议"),n("strong",[e._v("始终设定截止日期")]),e._v("，为什么呢？")]),e._v(" "),n("h3",{attrs:{id:"为什么要设置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#为什么要设置"}},[e._v("#")]),e._v(" 为什么要设置")]),e._v(" "),n("p",[e._v("当未设置 Deadlines 时，将采用默认的 DEADLINE_EXCEEDED（这个时间非常大）")]),e._v(" "),n("p",[e._v("如果产生了阻塞等待，就会造成大量正在进行的请求都会被保留，并且所有请求都有可能达到最大超时")]),e._v(" "),n("p",[e._v("这会使服务面临资源耗尽的风险，例如内存，这会增加服务的延迟，或者在最坏的情况下可能导致整个进程崩溃")]),e._v(" "),n("h2",{attrs:{id:"grpc"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#grpc"}},[e._v("#")]),e._v(" gRPC")]),e._v(" "),n("h3",{attrs:{id:"client"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#client"}},[e._v("#")]),e._v(" Client")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('func main() {\n    ...\n\tctx, cancel := context.WithDeadline(context.Background(), time.Now().Add(time.Duration(5 * time.Second)))\n\tdefer cancel()\n\n\tclient := pb.NewSearchServiceClient(conn)\n\tresp, err := client.Search(ctx, &pb.SearchRequest{\n\t\tRequest: "gRPC",\n\t})\n\tif err != nil {\n\t\tstatusErr, ok := status.FromError(err)\n\t\tif ok {\n\t\t\tif statusErr.Code() == codes.DeadlineExceeded {\n\t\t\t\tlog.Fatalln("client.Search err: deadline")\n\t\t\t}\n\t\t}\n\n\t\tlog.Fatalf("client.Search err: %v", err)\n\t}\n\n\tlog.Printf("resp: %s", resp.GetResponse())\n}\n')])])]),n("ul",[n("li",[e._v("context.WithDeadline：会返回最终上下文截止时间。第一个形参为父上下文，第二个形参为调整的截止时间。若父级时间早于子级时间，则以父级时间为准，否则以子级时间为最终截止时间")])]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("func WithDeadline(parent Context, d time.Time) (Context, CancelFunc) {\n\tif cur, ok := parent.Deadline(); ok && cur.Before(d) {\n\t\t// The current deadline is already sooner than the new one.\n\t\treturn WithCancel(parent)\n\t}\n\tc := &timerCtx{\n\t\tcancelCtx: newCancelCtx(parent),\n\t\tdeadline:  d,\n\t}\n\tpropagateCancel(parent, c)\n\tdur := time.Until(d)\n\tif dur <= 0 {\n\t\tc.cancel(true, DeadlineExceeded) // deadline has already passed\n\t\treturn c, func() { c.cancel(true, Canceled) }\n\t}\n\tc.mu.Lock()\n\tdefer c.mu.Unlock()\n\tif c.err == nil {\n\t\tc.timer = time.AfterFunc(dur, func() {\n\t\t\tc.cancel(true, DeadlineExceeded)\n\t\t})\n\t}\n\treturn c, func() { c.cancel(true, Canceled) }\n}\n")])])]),n("ul",[n("li",[e._v("context.WithTimeout：很常见的另外一个方法，是便捷操作。实际上是对于 WithDeadline 的封装")])]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("func WithTimeout(parent Context, timeout time.Duration) (Context, CancelFunc) {\n\treturn WithDeadline(parent, time.Now().Add(timeout))\n}\n")])])]),n("ul",[n("li",[e._v("status.FromError：返回 GRPCStatus 的具体错误码，若为非法，则直接返回 "),n("code",[e._v("codes.Unknown")])])]),e._v(" "),n("h3",{attrs:{id:"server"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#server"}},[e._v("#")]),e._v(" Server")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('type SearchService struct{}\n\nfunc (s *SearchService) Search(ctx context.Context, r *pb.SearchRequest) (*pb.SearchResponse, error) {\n\tfor i := 0; i < 5; i++  {\n\t\tif ctx.Err() == context.Canceled {\n\t\t\treturn nil, status.Errorf(codes.Canceled, "SearchService.Search canceled")\n\t\t}\n\n\t\ttime.Sleep(1 * time.Second)\n\t}\n\n\treturn &pb.SearchResponse{Response: r.GetRequest() + " Server"}, nil\n}\n\nfunc main() {\n\t...\n}\n')])])]),n("p",[e._v("而在 Server 端，由于 Client 已经设置了截止时间。Server 势必要去检测它")]),e._v(" "),n("p",[e._v("否则如果 Client 已经结束掉了，Server 还傻傻的在那执行，这对资源是一种极大的浪费")]),e._v(" "),n("p",[e._v("因此在这里需要用 "),n("code",[e._v("ctx.Err() == context.Canceled")]),e._v(" 进行判断，为了模拟场景我们加了循环和睡眠 🤔")]),e._v(" "),n("h3",{attrs:{id:"验证"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#验证"}},[e._v("#")]),e._v(" 验证")]),e._v(" "),n("p",[e._v("重新启动 server.go 和 client.go，得到结果：")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("$ go run client.go\n2018/10/06 17:45:55 client.Search err: deadline\nexit status 1\n")])])]),n("h2",{attrs:{id:"总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[e._v("#")]),e._v(" 总结")]),e._v(" "),n("p",[e._v("本章节比较简单，你需要知道以下知识点：")]),e._v(" "),n("ul",[n("li",[e._v("怎么设置 Deadlines")]),e._v(" "),n("li",[e._v("为什么要设置 Deadlines")])]),e._v(" "),n("p",[e._v("你要清楚地明白到，gRPC Deadlines 是很重要的，否则这小小的功能点就会要了你生产的命 🤫")]),e._v(" "),n("h2",{attrs:{id:"参考"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[e._v("#")]),e._v(" 参考")]),e._v(" "),n("h3",{attrs:{id:"本系列示例代码"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#本系列示例代码"}},[e._v("#")]),e._v(" 本系列示例代码")]),e._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"https://github.com/EDDYCJY/go-grpc-example",target:"_blank",rel:"noopener noreferrer"}},[e._v("go-grpc-example"),n("OutboundLink")],1)])]),e._v(" "),n("h3",{attrs:{id:"资料"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#资料"}},[e._v("#")]),e._v(" 资料")]),e._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"https://grpc.io/blog/deadlines",target:"_blank",rel:"noopener noreferrer"}},[e._v("gRPC and Deadlines\n"),n("OutboundLink")],1)])])])}),[],!1,null,null,null);t.default=r.exports}}]);