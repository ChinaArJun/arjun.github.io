(window.webpackJsonp=window.webpackJsonp||[]).push([[246],{681:function(t,s,a){"use strict";a.r(s);var r=a(44),n=Object(r.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"_9-1-go-大杀器之性能剖析-pprof"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_9-1-go-大杀器之性能剖析-pprof"}},[t._v("#")]),t._v(" 9.1 Go 大杀器之性能剖析 PProf")]),t._v(" "),a("h2",{attrs:{id:"前言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[t._v("#")]),t._v(" 前言")]),t._v(" "),a("p",[t._v("写了几吨代码，实现了几百个接口。功能测试也通过了，终于成功的部署上线了")]),t._v(" "),a("p",[t._v("结果，性能不佳，什么鬼？😭")]),t._v(" "),a("h2",{attrs:{id:"想做性能分析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#想做性能分析"}},[t._v("#")]),t._v(" 想做性能分析")]),t._v(" "),a("h3",{attrs:{id:"pprof"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pprof"}},[t._v("#")]),t._v(" PProf")]),t._v(" "),a("p",[t._v("想要进行性能优化，首先瞩目在 Go 自身提供的工具链来作为分析依据，本文将带你学习、使用 Go 后花园，涉及如下：")]),t._v(" "),a("ul",[a("li",[t._v("runtime/pprof：采集程序（非 Server）的运行数据进行分析")]),t._v(" "),a("li",[t._v("net/http/pprof：采集 HTTP Server 的运行时数据进行分析")])]),t._v(" "),a("h3",{attrs:{id:"是什么"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#是什么"}},[t._v("#")]),t._v(" 是什么")]),t._v(" "),a("p",[t._v("pprof 是用于可视化和分析性能分析数据的工具")]),t._v(" "),a("p",[t._v("pprof 以 "),a("a",{attrs:{href:"https://github.com/google/pprof/blob/master/proto/profile.proto",target:"_blank",rel:"noopener noreferrer"}},[t._v("profile.proto"),a("OutboundLink")],1),t._v(" 读取分析样本的集合，并生成报告以可视化并帮助分析数据（支持文本和图形报告）")]),t._v(" "),a("p",[t._v("profile.proto 是一个 Protocol Buffer v3 的描述文件，它描述了一组 callstack 和 symbolization 信息， 作用是表示统计分析的一组采样的调用栈，是很常见的 stacktrace 配置文件格式")]),t._v(" "),a("h3",{attrs:{id:"支持什么使用模式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#支持什么使用模式"}},[t._v("#")]),t._v(" 支持什么使用模式")]),t._v(" "),a("ul",[a("li",[t._v("Report generation：报告生成")]),t._v(" "),a("li",[t._v("Interactive terminal use：交互式终端使用")]),t._v(" "),a("li",[t._v("Web interface：Web 界面")])]),t._v(" "),a("h3",{attrs:{id:"可以做什么"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#可以做什么"}},[t._v("#")]),t._v(" 可以做什么")]),t._v(" "),a("ul",[a("li",[t._v("CPU Profiling：CPU 分析，按照一定的频率采集所监听的应用程序 CPU（含寄存器）的使用情况，可确定应用程序在主动消耗 CPU 周期时花费时间的位置")]),t._v(" "),a("li",[t._v("Memory Profiling：内存分析，在应用程序进行堆分配时记录堆栈跟踪，用于监视当前和历史内存使用情况，以及检查内存泄漏")]),t._v(" "),a("li",[t._v("Block Profiling：阻塞分析，记录 goroutine 阻塞等待同步（包括定时器通道）的位置")]),t._v(" "),a("li",[t._v("Mutex Profiling：互斥锁分析，报告互斥锁的竞争情况")])]),t._v(" "),a("h2",{attrs:{id:"一个简单的例子"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一个简单的例子"}},[t._v("#")]),t._v(" 一个简单的例子")]),t._v(" "),a("p",[t._v("我们将编写一个简单且有点问题的例子，用于基本的程序初步分析")]),t._v(" "),a("h3",{attrs:{id:"编写-demo-文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#编写-demo-文件"}},[t._v("#")]),t._v(" 编写 demo 文件")]),t._v(" "),a("p",[t._v("（1）demo.go，文件内容：")]),t._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),t._v(" main\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"log"')]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"net/http"')]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("_")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"net/http/pprof"')]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"github.com/EDDYCJY/go-pprof-example/data"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("main")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("go")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\tlog"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Println")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Add")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"https://github.com/EDDYCJY"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\thttp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ListenAndServe")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0.0.0.0:6060"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("（2）data/d.go，文件内容：")]),t._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),t._v(" data\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" datas "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Add")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("str "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tdata "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("byte")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("str"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tsData "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("string")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tdatas "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("append")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("datas"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" sData"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" sData\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n")])])]),a("p",[t._v("运行这个文件，你的 HTTP 服务会多出 /debug/pprof 的 endpoint 可用于观察应用程序的情况")]),t._v(" "),a("h3",{attrs:{id:"分析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#分析"}},[t._v("#")]),t._v(" 分析")]),t._v(" "),a("h4",{attrs:{id:"一、通过-web-界面"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、通过-web-界面"}},[t._v("#")]),t._v(" 一、通过 Web 界面")]),t._v(" "),a("p",[t._v("查看当前总览：访问 "),a("code",[t._v("http://127.0.0.1:6060/debug/pprof/")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("/debug/pprof/\n\nprofiles:\n0\tblock\n5\tgoroutine\n3\theap\n0\tmutex\n9\tthreadcreate\n\nfull goroutine stack dump\n")])])]),a("p",[t._v("这个页面中有许多子页面，咱们继续深究下去，看看可以得到什么？")]),t._v(" "),a("ul",[a("li",[t._v("cpu（CPU Profiling）: "),a("code",[t._v("$HOST/debug/pprof/profile")]),t._v("，默认进行 30s 的 CPU Profiling，得到一个分析用的 profile 文件")]),t._v(" "),a("li",[t._v("block（Block Profiling）："),a("code",[t._v("$HOST/debug/pprof/block")]),t._v("，查看导致阻塞同步的堆栈跟踪")]),t._v(" "),a("li",[t._v("goroutine："),a("code",[t._v("$HOST/debug/pprof/goroutine")]),t._v("，查看当前所有运行的 goroutines 堆栈跟踪")]),t._v(" "),a("li",[t._v("heap（Memory Profiling）: "),a("code",[t._v("$HOST/debug/pprof/heap")]),t._v("，查看活动对象的内存分配情况")]),t._v(" "),a("li",[t._v("mutex（Mutex Profiling）："),a("code",[t._v("$HOST/debug/pprof/mutex")]),t._v("，查看导致互斥锁的竞争持有者的堆栈跟踪")]),t._v(" "),a("li",[t._v("threadcreate："),a("code",[t._v("$HOST/debug/pprof/threadcreate")]),t._v("，查看创建新OS线程的堆栈跟踪")])]),t._v(" "),a("h4",{attrs:{id:"二、通过交互式终端使用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、通过交互式终端使用"}},[t._v("#")]),t._v(" 二、通过交互式终端使用")]),t._v(" "),a("p",[t._v("（1）go tool pprof http://localhost:6060/debug/pprof/profile?seconds=60")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[t._v("$ go tool pprof http://localhost:6060/debug/pprof/profile"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("?seconds"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("60")]),t._v("\n\nFetching profile over HTTP from http://localhost:6060/debug/pprof/profile?seconds"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("60")]),t._v("\nSaved profile "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" /Users/eddycjy/pprof/pprof.samples.cpu.007.pb.gz\nType: cpu\nDuration: 1mins, Total samples "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("26")]),t._v(".55s "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("44.15")]),t._v("%"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nEntering interactive mode "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("type "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"help"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" commands, "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"o"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" options"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pprof"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" \n")])])]),a("p",[t._v("执行该命令后，需等待 60 秒（可调整 seconds 的值），pprof 会进行 CPU Profiling。结束后将默认进入 pprof 的交互式命令模式，可以对分析的结果进行查看或导出。具体可执行 "),a("code",[t._v("pprof help")]),t._v(" 查看命令说明")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pprof"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" top10\nShowing nodes accounting "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("25")]),t._v(".92s, "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("97.63")]),t._v("% of "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("26")]),t._v(".55s total\nDropped "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("85")]),t._v(" nodes "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cum "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(".13s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nShowing "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("top")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v(" nodes out of "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("21")]),t._v("\n      flat  flat%   sum%        cum   cum%\n    "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("23")]),t._v(".28s "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("87.68")]),t._v("% "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("87.68")]),t._v("%     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("23")]),t._v(".29s "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("87.72")]),t._v("%  syscall.Syscall\n     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(".77s  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.90")]),t._v("% "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("90.58")]),t._v("%      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(".77s  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.90")]),t._v("%  runtime.memmove\n     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(".58s  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.18")]),t._v("% "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("92.77")]),t._v("%      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(".58s  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.18")]),t._v("%  runtime.freedefer\n     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(".53s  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.00")]),t._v("% "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("94.76")]),t._v("%      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(".42s  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5.35")]),t._v("%  runtime.scanobject\n     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(".36s  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.36")]),t._v("% "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("96.12")]),t._v("%      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(".39s  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.47")]),t._v("%  runtime.heapBitsForObject\n     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(".35s  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.32")]),t._v("% "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("97.44")]),t._v("%      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(".45s  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.69")]),t._v("%  runtime.greyobject\n     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(".02s "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.075")]),t._v("% "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("97.51")]),t._v("%     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("24")]),t._v(".96s "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("94.01")]),t._v("%  main.main.func1\n     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(".01s "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.038")]),t._v("% "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("97.55")]),t._v("%     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("23")]),t._v(".91s "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("90.06")]),t._v("%  os."),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("*File"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(".Write\n     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(".01s "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.038")]),t._v("% "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("97.59")]),t._v("%      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(".19s  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.72")]),t._v("%  runtime.mallocgc\n     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(".01s "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.038")]),t._v("% "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("97.63")]),t._v("%     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("23")]),t._v(".30s "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("87.76")]),t._v("%  syscall.Write\n")])])]),a("ul",[a("li",[t._v("flat：给定函数上运行耗时")]),t._v(" "),a("li",[t._v("flat%：同上的 CPU 运行耗时总比例")]),t._v(" "),a("li",[t._v("sum%：给定函数累积使用 CPU 总比例")]),t._v(" "),a("li",[t._v("cum：当前函数加上它之上的调用运行总耗时")]),t._v(" "),a("li",[t._v("cum%：同上的 CPU 运行耗时总比例")])]),t._v(" "),a("p",[t._v("最后一列为函数名称，在大多数的情况下，我们可以通过这五列得出一个应用程序的运行情况，加以优化 🤔")]),t._v(" "),a("p",[t._v("（2）go tool pprof http://localhost:6060/debug/pprof/heap")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[t._v("$ go tool pprof http://localhost:6060/debug/pprof/heap\nFetching profile over HTTP from http://localhost:6060/debug/pprof/heap\nSaved profile "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" /Users/eddycjy/pprof/pprof.alloc_objects.alloc_space.inuse_objects.inuse_space.008.pb.gz\nType: inuse_space\nEntering interactive mode "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("type "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"help"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" commands, "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"o"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" options"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pprof"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("top")]),t._v("\nShowing nodes accounting "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("837")]),t._v(".48MB, "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),t._v("% of "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("837")]),t._v(".48MB total\n      flat  flat%   sum%        cum   cum%\n  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("837")]),t._v(".48MB   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),t._v("%   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),t._v("%   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("837")]),t._v(".48MB   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),t._v("%  main.main.func1\n")])])]),a("ul",[a("li",[a("p",[t._v("-inuse_space：分析应用程序的常驻内存占用情况")])]),t._v(" "),a("li",[a("p",[t._v("-alloc_objects：分析应用程序的内存临时分配情况")])])]),t._v(" "),a("p",[t._v("（3） go tool pprof http://localhost:6060/debug/pprof/block")]),t._v(" "),a("p",[t._v("（4） go tool pprof http://localhost:6060/debug/pprof/mutex")]),t._v(" "),a("h4",{attrs:{id:"三、pprof-可视化界面"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三、pprof-可视化界面"}},[t._v("#")]),t._v(" 三、PProf 可视化界面")]),t._v(" "),a("p",[t._v("这是令人期待的一小节。在这之前，我们需要简单的编写好测试用例来跑一下")]),t._v(" "),a("h5",{attrs:{id:"编写测试用例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#编写测试用例"}},[t._v("#")]),t._v(" 编写测试用例")]),t._v(" "),a("p",[t._v("（1）新建 data/d_test.go，文件内容：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('package data\n\nimport "testing"\n\nconst url = "https://github.com/EDDYCJY"\n\nfunc TestAdd(t *testing.T) {\n\ts := Add(url)\n\tif s == "" {\n\t\tt.Errorf("Test.Add error!")\n\t}\n}\n\nfunc BenchmarkAdd(b *testing.B) {\n\tfor i := 0; i < b.N; i++ {\n\t\tAdd(url)\n\t}\n}\n')])])]),a("p",[t._v("（2）执行测试用例")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("$ go test -bench=. -cpuprofile=cpu.prof\npkg: github.com/EDDYCJY/go-pprof-example/data\nBenchmarkAdd-4   \t10000000\t       187 ns/op\nPASS\nok  \tgithub.com/EDDYCJY/go-pprof-example/data\t2.300s\n")])])]),a("p",[t._v("-memprofile 也可以了解一下")]),t._v(" "),a("h5",{attrs:{id:"启动-pprof-可视化界面"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#启动-pprof-可视化界面"}},[t._v("#")]),t._v(" 启动 PProf 可视化界面")]),t._v(" "),a("h6",{attrs:{id:"方法一："}},[a("a",{staticClass:"header-anchor",attrs:{href:"#方法一："}},[t._v("#")]),t._v(" 方法一：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("$ go tool pprof -http=:8080 cpu.prof\n")])])]),a("h6",{attrs:{id:"方法二："}},[a("a",{staticClass:"header-anchor",attrs:{href:"#方法二："}},[t._v("#")]),t._v(" 方法二：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("$ go tool pprof cpu.prof \n$ (pprof) web\n")])])]),a("p",[t._v("如果出现 "),a("code",[t._v("Could not execute dot; may need to install graphviz.")]),t._v("，就是提示你要安装 "),a("code",[t._v("graphviz")]),t._v(" 了 （请右拐谷歌）")]),t._v(" "),a("h5",{attrs:{id:"查看-pprof-可视化界面"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查看-pprof-可视化界面"}},[t._v("#")]),t._v(" 查看 PProf 可视化界面")]),t._v(" "),a("p",[t._v("（1）Top")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://i.imgur.com/RxJO0zH.jpg",alt:"image"}})]),t._v(" "),a("p",[t._v("（2）Graph")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://i.imgur.com/Bowv9PX.jpg",alt:"image"}})]),t._v(" "),a("p",[t._v("框越大，线越粗代表它占用的时间越大哦")]),t._v(" "),a("p",[t._v("（3）Peek")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://i.imgur.com/V67zTDQ.jpg",alt:"image"}})]),t._v(" "),a("p",[t._v("（4）Source")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://i.imgur.com/3K81wyn.jpg",alt:"image"}})]),t._v(" "),a("p",[t._v("通过 PProf 的可视化界面，我们能够更方便、更直观的看到 Go 应用程序的调用链、使用情况等，并且在 View 菜单栏中，还支持如上多种方式的切换")]),t._v(" "),a("p",[t._v("你想想，在烦恼不知道什么问题的时候，能用这些辅助工具来检测问题，是不是瞬间效率翻倍了呢 👌")]),t._v(" "),a("h4",{attrs:{id:"四、pprof-火焰图"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#四、pprof-火焰图"}},[t._v("#")]),t._v(" 四、PProf 火焰图")]),t._v(" "),a("p",[t._v("另一种可视化数据的方法是火焰图，需手动安装原生 PProf 工具：")]),t._v(" "),a("p",[t._v("（1） 安装 PProf")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("$ go get -u github.com/google/pprof\n")])])]),a("p",[t._v("（2） 启动 PProf 可视化界面:")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("$ pprof -http=:8080 cpu.prof\n")])])]),a("p",[t._v("（3） 查看 PProf 可视化界面")]),t._v(" "),a("p",[t._v("打开 PProf 的可视化界面时，你会明显发现比官方工具链的 PProf 精致一些，并且多了 Flame Graph（火焰图）")]),t._v(" "),a("p",[t._v("它就是本次的目标之一，它的最大优点是动态的。调用顺序由上到下（A -> B -> C -> D），每一块代表一个函数，越大代表占用 CPU 的时间更长。同时它也支持点击块深入进行分析！")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://i.imgur.com/g58bQpg.jpg",alt:"image"}})]),t._v(" "),a("h2",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),a("p",[t._v("在本章节，粗略地介绍了 Go 的性能利器 PProf。在特定的场景中，PProf 给定位、剖析问题带了极大的帮助")]),t._v(" "),a("p",[t._v("希望本文对你有所帮助，另外建议能够自己实际操作一遍，最好是可以深入琢磨一下，内含大量的用法、知识点 🤓")]),t._v(" "),a("h2",{attrs:{id:"思考题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#思考题"}},[t._v("#")]),t._v(" 思考题")]),t._v(" "),a("p",[t._v("你很优秀的看到了最后，那么有两道简单的思考题，希望拓展你的思路")]),t._v(" "),a("p",[t._v("（1）flat 一定大于 cum 吗，为什么？什么场景下 cum 会比 flat 大？")]),t._v(" "),a("p",[t._v("（2）本章节的 demo 代码，有什么性能问题？怎么解决它？")])])}),[],!1,null,null,null);s.default=n.exports}}]);