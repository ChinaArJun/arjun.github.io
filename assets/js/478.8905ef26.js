(window.webpackJsonp=window.webpackJsonp||[]).push([[478],{917:function(t,s,a){"use strict";a.r(s);var n=a(44),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"更新日志"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#更新日志"}},[t._v("#")]),t._v(" 更新日志")]),t._v(" "),a("h2",{attrs:{id:"v1-0"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#v1-0"}},[t._v("#")]),t._v(" v1.0")]),t._v(" "),a("h3",{attrs:{id:"破坏性变更"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#破坏性变更"}},[t._v("#")]),t._v(" 破坏性变更")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("gorm.Open")]),t._v("返回类型为"),a("code",[t._v("*gorm.DB")]),t._v("而不是"),a("code",[t._v("gorm.DB")])]),t._v(" "),a("li",[t._v("更新只会更新更改的字段")])]),t._v(" "),a("p",[t._v("大多数应用程序不会受到影响，只有当您更改回调中的更新值（如"),a("code",[t._v("BeforeSave")]),t._v("，"),a("code",[t._v("BeforeUpdate")]),t._v("）时，应该使用"),a("code",[t._v("scope.SetColumn")]),t._v("，例如：")]),t._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("user "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("User"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("BeforeUpdate")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("scope "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("gorm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Scope"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" pw"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" bcrypt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("GenerateFromPassword")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Password"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    scope"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("SetColumn")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"EncryptedPassword"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pw"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// user.EncryptedPassword = pw  // 不工作，更新时不会包括EncryptedPassword字段")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("ul",[a("li",[t._v("软删除的默认查询作用域只会检查"),a("code",[t._v("deleted_at IS NULL")])])]),t._v(" "),a("p",[t._v("之前它会检查deleted_at小于0001-01-02也排除空白时间，如：")]),t._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[t._v("SELECT "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" FROM users WHERE deleted_at IS NULL OR deleted_at "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'0001-01-02'")]),t._v("\n")])])]),a("p",[t._v("但是没有必要，如果你使用"),a("code",[t._v("*time.Time")]),t._v("作为模型的"),a("code",[t._v("DeletedAt")]),t._v("，它已经被"),a("code",[t._v("gorm.Model")]),t._v("使用了，所以SQL就足够了")]),t._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[t._v("SELECT "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" FROM users WHERE deleted_at IS NULL\n")])])]),a("p",[t._v("所以如果你使用"),a("code",[t._v("gorm.Model")]),t._v("，那么你是好的，没有什么需要改变，只要确保所有记录的空白时间为"),a("code",[t._v("deleted_at")]),t._v("设置为"),a("code",[t._v("NULL")]),t._v("，示例迁移脚本：")]),t._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"github.com/jinzhu/now"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("main")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" models "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("interface")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("User"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("Image"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("_")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" model "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("range")]),t._v(" models "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Unscoped")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Model")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("model"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Where")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"deleted_at < ?"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" now"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("MustParse")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0001-01-02"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Update")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"deleted_at"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" gorm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Expr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"NULL"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("ul",[a("li",[t._v("新的ToDBName逻辑")])]),t._v(" "),a("p",[t._v("在GORM将struct，Field的名称转换为db名称之前，只有那些来自"),a("a",{attrs:{href:"https://github.com/golang/lint/blob/master/lint.go#L702",target:"_blank",rel:"noopener noreferrer"}},[t._v("golint"),a("OutboundLink")],1),t._v("的常见初始化（如"),a("code",[t._v("HTTP")]),t._v("，"),a("code",[t._v("URI")]),t._v("）是特殊处理的。")]),t._v(" "),a("p",[t._v("所以字段"),a("code",[t._v("HTTP")]),t._v("的数据库名称将是"),a("code",[t._v("http")]),t._v("而不是"),a("code",[t._v("h_t_t_p")]),t._v("，但是一些其他的初始化，如"),a("code",[t._v("SKU")]),t._v("不在golint，它的数据库名称将是"),a("code",[t._v("s_k_u")]),t._v("，这看起来很丑陋，这个版本固定这个，任何大写的初始化应该正确转换。")]),t._v(" "),a("ul",[a("li",[t._v("错误"),a("code",[t._v("RecordNotFound")]),t._v("已重命名为"),a("code",[t._v("ErrRecordNotFound")])]),t._v(" "),a("li",[a("code",[t._v("mssql")]),t._v("驱动程序已从默认驱动程序中删除，导入它用"),a("code",[t._v('import _ "github.com/jinzhu/gorm/dialects/mssql"')])]),t._v(" "),a("li",[a("code",[t._v("Hstore")]),t._v("已移至"),a("code",[t._v("github.com/jinzhu/gorm/dialects/postgres")])])])])}),[],!1,null,null,null);s.default=e.exports}}]);